

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bio_rtd.uo.sc_uo &mdash; bio_rtd  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> bio_rtd
          

          
          </a>

          
            
            
              <div class="version">
                0.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Home</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bio_rtd</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>bio_rtd.uo.sc_uo</li>
    
    

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bio_rtd.uo.sc_uo</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AlternatingChromatography&#39;</span><span class="p">,</span> <span class="s1">&#39;ACC&#39;</span><span class="p">,</span> <span class="s1">&#39;PCC&#39;</span><span class="p">,</span> <span class="s1">&#39;PCCWithWashDesorption&#39;</span><span class="p">]</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Jure Sencar&#39;</span>

<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">_typing</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">_interp</span>

<span class="kn">import</span> <span class="nn">bio_rtd.utils</span> <span class="k">as</span> <span class="nn">_utils</span>
<span class="kn">import</span> <span class="nn">bio_rtd.core</span> <span class="k">as</span> <span class="nn">_core</span>
<span class="kn">import</span> <span class="nn">bio_rtd.pdf</span> <span class="k">as</span> <span class="nn">_pdf</span>


<div class="viewcode-block" id="AlternatingChromatography"><a class="viewcode-back" href="../../../bio_rtd/uo.sc_uo.html#bio_rtd.uo.sc_uo.AlternatingChromatography">[docs]</a><span class="k">class</span> <span class="nc">AlternatingChromatography</span><span class="p">(</span><span class="n">_core</span><span class="o">.</span><span class="n">UnitOperation</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">t</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">uo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">load_bt</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">ChromatographyLoadBreakthrough</span><span class="p">,</span>
                 <span class="n">peak_shape_pdf</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span>
                 <span class="n">gui_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ACC&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">uo_id</span><span class="p">,</span> <span class="n">gui_title</span><span class="p">)</span>
        <span class="c1"># get load breakthrough profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span> <span class="o">=</span> <span class="n">load_bt</span>
        <span class="c1"># get elution peak pdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_shape</span> <span class="o">=</span> <span class="n">peak_shape_pdf</span>

        <span class="c1"># process buffer species that are not binding to the column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># column volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># column volume</span>
        <span class="sd">&quot;&quot;&quot;Column volume&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_porosity_retentate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># column porosity for product</span>
        <span class="sd">&quot;&quot;&quot;Column rtm&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft_mean_retentate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># flow-through time for product (cv = f * ft_mean_retentate / porosity_retentate)</span>

        <span class="c1"># duration of equilibration step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># equilibration step flow rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_f_rel</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># equilibration flow rate relative to the load flow rate</span>

        <span class="c1"># duration of the load phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># load duration in CV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_ss</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># breakthrough concentration upper limit (CV &lt;&lt; load)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_relative_ss</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># relative breakthrough concentration upper limit (CV &lt;&lt; load)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_estimate_with_iterative_solver</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># finer optimization of cycle length determination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_estimate_with_iterative_solver_max_iter</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="c1"># extend first load phase (to achieve a faster steady-state)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># target load linear velocity (in order to estimate column length / diameter ratio)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_target_lin_velocity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># units need to match other units chosen for the model</span>

        <span class="c1"># duration of the wash step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># wash step flow rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_f_rel</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># wash flow rate relative to the load flow rate</span>

        <span class="c1"># Elution peak is scaled down by 1 - `unaccounted_losses_rel`.</span>
        <span class="c1"># Peak cut criteria is applied after the scale down.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unaccounted_losses_rel</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># duration of elution step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># elution flow rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_f_rel</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># elution flow rate relative to the load flow rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_buffer_c</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="c1"># peak position within elution step (1st moment, not max)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_position_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_position_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># elution peak cut</span>
        <span class="c1"># start (one of them needs to be defined)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_c_rel_to_peak_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_peak_area_share</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># end (one of them needs to be defined)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_c_rel_to_peak_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_peak_area_share</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># duration of regeneration step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># regeneration step flow rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_f_rel</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># wash flow rate relative to the load flow rate</span>

        <span class="c1"># option to simulate desorption during wash step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># For PCC</span>
        <span class="c1"># option to capture load breakthrough onto next column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># propagation dynamics of unbound material through the column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_core</span><span class="o">.</span><span class="n">PDF</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># option to capture breakthrough material during wash step onto third column (2nd is on load step)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># duration of wash recycling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle_duration_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle_duration_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@_core</span><span class="o">.</span><span class="n">UnitOperation</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">RtdLogger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="c1"># propagate logger across other elements with logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">set_data_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span><span class="o">.</span><span class="n">set_logger_from_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uo_id</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_shape</span><span class="o">.</span><span class="n">set_logger_from_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uo_id</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span><span class="o">.</span><span class="n">set_logger_from_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uo_id</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_flow_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flow</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rel_flow</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rel_flow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">rel_flow</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="n">step_name</span> <span class="o">+</span> <span class="s2">&quot; step flow rate is not defined, using load flow rate instead&quot;</span><span class="p">)</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span>
        <span class="k">return</span> <span class="n">flow</span>

    <span class="k">def</span> <span class="nf">_get_time_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">cv</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">flow</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">t_sum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">flow</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">step_name</span> <span class="o">+</span> <span class="s2">&quot;: Flow rate must be defined ( &gt; 0 ) if the duration was specified in CVs.&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;CV must be determined (by `calc_cv`) before calculating duration based on CVs&quot;</span>
            <span class="n">t_sum</span> <span class="o">+=</span> <span class="n">cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="n">flow</span>  <span class="c1"># sum</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cv</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># log</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="n">step_name</span> <span class="o">+</span> <span class="s2">&quot; time is not defined&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">t_sum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t_sum</span>  <span class="c1"># return</span>

    <span class="k">def</span> <span class="nf">_assert_non_binding_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure binding species list is valid</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span><span class="p">,</span> \
                <span class="s2">&quot;Index of non_binding_species too large (indexes start with 0)&quot;</span>
            <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">))</span> \
                <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">),</span> \
                <span class="s2">&quot;List of non_binding_species should have ascending order&quot;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span><span class="p">,</span> \
                <span class="s2">&quot;All species cannot be non-binding.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span>
                        <span class="s1">&#39;non_binding_species&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_load_f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_flow_box_shaped</span><span class="p">(),</span> <span class="s2">&quot;Inlet flow must be box shaped&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;load_f&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_cv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_single_non_negative_parameter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">,</span>
            <span class="n">ft_mean_retentate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ft_mean_retentate</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.ft_mean_retentate &gt; 0:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_porosity_retentate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> \
                <span class="s2">&quot;porosity_retentate must be defined to calc CV from &quot;</span> \
                <span class="s2">&quot;ft_mean_retentate&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;load flow rate must be defined to calc CV from ft_mean_retentate&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft_mean_retentate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_porosity_retentate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_report_column_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># report column dimensions based on desired load linear velocity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_target_lin_velocity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_col_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_target_lin_velocity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;column_h&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_h</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;column_d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_col_h</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_equilibration_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># flow rate</span>
            <span class="n">eq_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flow_value</span><span class="p">(</span>
                <span class="s2">&quot;Equilibration&quot;</span><span class="p">,</span> <span class="s2">&quot;equilibration_f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_f_rel</span>
            <span class="p">)</span>
            <span class="c1"># duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_equilibration_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_value</span><span class="p">(</span>
                <span class="s2">&quot;Equilibration&quot;</span><span class="p">,</span> <span class="s2">&quot;equilibration_t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibration_cv</span><span class="p">,</span> <span class="n">eq_f</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_equilibration_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equilibration_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;equilibration_t&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equilibration_t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_wash_t_and_f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># flow rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flow_value</span><span class="p">(</span><span class="s2">&quot;Wash&quot;</span><span class="p">,</span> <span class="s2">&quot;wash_f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_f_rel</span><span class="p">)</span>
        <span class="c1"># duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_value</span><span class="p">(</span><span class="s2">&quot;Wash&quot;</span><span class="p">,</span> <span class="s2">&quot;wash_t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_cv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_elution_t_and_f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># flow rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flow_value</span><span class="p">(</span><span class="s2">&quot;Elution&quot;</span><span class="p">,</span> <span class="s2">&quot;elution_f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_f_rel</span><span class="p">)</span>
        <span class="c1"># duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_value</span><span class="p">(</span><span class="s2">&quot;Elution&quot;</span><span class="p">,</span> <span class="s2">&quot;elution_t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_cv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_elution_peak_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># elution peak mean position (1st momentum)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_value</span><span class="p">(</span>
            <span class="s2">&quot;elution peak position&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elution_peak_position_t&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_position_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_position_cv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_elution_peak_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_t</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># calc elution peak shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_shape</span><span class="o">.</span><span class="n">update_pdf</span><span class="p">(</span>
            <span class="n">rt_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_t</span><span class="p">,</span>
            <span class="n">v_void</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_t</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span><span class="p">,</span>
            <span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_elution_peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_shape</span><span class="o">.</span><span class="n">get_p</span><span class="p">()</span> \
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">unaccounted_losses_rel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;p_elution_peak&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_elution_peak</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_elution_peak_cut_i_start_and_i_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">elution_peak_pdf</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_elution_peak</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># start peak cut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_single_non_negative_parameter</span><span class="p">(</span>
            <span class="n">log_level_multiple</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">log_level_none</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
            <span class="n">elution_peak_cut_start_peak_area_share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_peak_area_share</span><span class="p">,</span>
            <span class="n">elution_peak_cut_start_c_rel_to_peak_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_c_rel_to_peak_max</span><span class="p">,</span>
            <span class="n">elution_peak_cut_start_cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_cv</span><span class="p">,</span>
            <span class="n">elution_peak_cut_start_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_t</span>
        <span class="p">)</span>
        <span class="c1"># calc elution_peak_cut_start_i</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_peak_area_share</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_start_i</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start</span><span class="p">(</span>
                <span class="n">_np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">elution_peak_pdf</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_peak_area_share</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_c_rel_to_peak_max</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_start_i</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start</span><span class="p">(</span>
                <span class="n">elution_peak_pdf</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_c_rel_to_peak_max</span> <span class="o">*</span> <span class="n">elution_peak_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_cv</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_start_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_start_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_start_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Elution peak cut start is not defined. Now collecting from the beginning of the elution phase&quot;</span><span class="p">)</span>
            <span class="n">elution_peak_cut_start_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># log results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;elution_peak_cut_start_i&quot;</span><span class="p">,</span> <span class="n">elution_peak_cut_start_i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;elution_peak_cut_start_t&quot;</span><span class="p">,</span> <span class="n">elution_peak_cut_start_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>

        <span class="c1"># end peak cut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_single_non_negative_parameter</span><span class="p">(</span>
            <span class="n">log_level_multiple</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">log_level_none</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
            <span class="n">elution_peak_cut_end_peak_area_share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_peak_area_share</span><span class="p">,</span>
            <span class="n">elution_peak_cut_end_c_rel_to_peak_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_c_rel_to_peak_max</span><span class="p">,</span>
            <span class="n">elution_peak_cut_end_cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_cv</span><span class="p">,</span>
            <span class="n">elution_peak_cut_end_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_t</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># calc elution_peak_cut_end_i</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_peak_area_share</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_end_i</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start</span><span class="p">(</span>
                <span class="n">_np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">elution_peak_pdf</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_peak_area_share</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_c_rel_to_peak_max</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_end_i</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_end</span><span class="p">(</span>
                <span class="n">elution_peak_pdf</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_c_rel_to_peak_max</span> <span class="o">*</span> <span class="n">elution_peak_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_cv</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_end_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_peak_cut_end_i</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_end</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_peak_cut_end_t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Elution peak cut end is not defined. Now collecting to the end of the elution phase&quot;</span><span class="p">)</span>
            <span class="n">elution_peak_cut_end_i</span> <span class="o">=</span> <span class="n">elution_peak_pdf</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># log results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;elution_peak_cut_end_i&quot;</span><span class="p">,</span> <span class="n">elution_peak_cut_end_i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;elution_peak_cut_end_t&quot;</span><span class="p">,</span> <span class="n">elution_peak_cut_end_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_cut_start_i</span> <span class="o">=</span> <span class="n">elution_peak_cut_start_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_cut_end_i</span> <span class="o">=</span> <span class="n">elution_peak_cut_end_i</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_cut_end_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_t</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Peak end is cut before its maximum&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_cut_end_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_t</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Peak cut end exceeds elution step duration&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">elution_peak_cut_start_i</span><span class="p">,</span> <span class="n">elution_peak_cut_end_i</span>

    <span class="k">def</span> <span class="nf">_calc_elution_peak_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_mask</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elution_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_cut_end_i</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_mask</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_cut_start_i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;elution_peak_interval&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_load_btc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;CV must be defined by now&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span><span class="o">.</span><span class="n">update_btc_parameters</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cv</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_regeneration_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># flow rate</span>
            <span class="n">eq_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flow_value</span><span class="p">(</span>
                <span class="s2">&quot;Regeneration&quot;</span><span class="p">,</span> <span class="s2">&quot;regeneration_f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_f_rel</span>
            <span class="p">)</span>
            <span class="c1"># duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_regeneration_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_value</span><span class="p">(</span>
                <span class="s2">&quot;Regeneration&quot;</span><span class="p">,</span> <span class="s2">&quot;regeneration_t&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regeneration_cv</span><span class="p">,</span> <span class="n">eq_f</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_regeneration_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regeneration_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;regeneration_t&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regeneration_t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_load_recycle_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates pdf that describes propagation dynamics of unbound and desorbed material throughout the column.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;load_recycle_pdf must be defined&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_porosity_retentate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Retentate porosity must be defined&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;CV must be defined by now&quot;</span>

        <span class="n">v_void</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_porosity_retentate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span><span class="o">.</span><span class="n">update_pdf</span><span class="p">(</span><span class="n">v_void</span><span class="o">=</span><span class="n">v_void</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span> <span class="n">rt_mean</span><span class="o">=</span><span class="n">v_void</span> <span class="o">/</span> <span class="n">flow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_load_recycle_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span><span class="o">.</span><span class="n">get_p</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calc_load_recycle_wash_i</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle_duration_t</span> <span class="o">&gt;</span> <span class="mi">0</span> \
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle_duration_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_time_value</span><span class="p">(</span>
                <span class="s2">&quot;Wash recycle&quot;</span><span class="p">,</span> <span class="s2">&quot;load_wash_recycle_t&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle_duration_t</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle_duration_cv</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span>
            <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># same as wash duration</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_load_bt_cycle_switch_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_c_ss</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_ss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_relative_ss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> \
            <span class="s2">&quot;Load step duration should be defined!&quot;</span>

        <span class="c1"># calc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_ss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">load_c_end_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_ss</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_relative_ss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Cycle time defined by `load_c_end_ss` and `load_c_end_relative_ss`.&quot;</span>
                           <span class="s2">&quot;Simulation is using `load_c_end_ss`.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.load_c_end_relative_ss &gt; 0</span>
            <span class="n">load_c_end_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_relative_ss</span> <span class="o">*</span> <span class="n">load_c_ss</span>

        <span class="c1"># add to log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;load_c_end_ss&#39;</span><span class="p">,</span> <span class="n">load_c_end_ss</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">load_c_end_ss</span>

    <span class="c1"># noinspection DuplicatedCode</span>
    <span class="k">def</span> <span class="nf">_calc_cycle_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates cycle time.</span>

<span class="sd">        Optional delay of first cycle is not part of this function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t_cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_ss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_relative_ss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Cycle time defined in more than one way. Simulation is using `load_cv`.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ## get bt profile for constant inlet ##</span>
            <span class="c1"># inlet c</span>
            <span class="n">binding_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">]</span>
            <span class="n">load_c_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_steady_state_mean_c</span><span class="p">(</span><span class="n">binding_species</span><span class="p">)</span>

            <span class="c1">#  simulate first cycle at constant load concentration</span>
            <span class="n">f_first_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">c_first_load</span> <span class="o">=</span> <span class="n">load_c_ss</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">binding_species</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
            <span class="n">bt_first_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">load_c_ss</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span><span class="o">.</span><span class="n">calc_c_bound</span><span class="p">(</span><span class="n">f_first_load</span><span class="p">,</span> <span class="n">c_first_load</span><span class="p">)</span>

            <span class="c1"># propagate breakthrough</span>
            <span class="n">bt_first_load_out</span><span class="p">,</span> <span class="n">bt_first_wash_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_recycle_propagation</span><span class="p">(</span><span class="n">f_first_load</span><span class="p">,</span> <span class="n">bt_first_load</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># calc cycle duration</span>
            <span class="n">load_c_end_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_load_bt_cycle_switch_limit</span><span class="p">(</span><span class="n">load_c_ss</span><span class="p">)</span>
            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="n">i_t_first_cycle</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start</span><span class="p">(</span><span class="n">bt_first_load_out</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">load_c_end_ss</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">t_cycle</span> <span class="o">=</span> <span class="n">i_t_first_cycle</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>

            <span class="c1"># wash desorption</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
                <span class="n">c_wash_desorbed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_wash_desorption</span><span class="p">(</span>
                    <span class="n">f_first_load</span><span class="p">[:</span><span class="n">i_t_first_cycle</span><span class="p">],</span>
                    <span class="n">c_first_load</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_t_first_cycle</span><span class="p">]</span> <span class="o">-</span> <span class="n">bt_first_load</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_t_first_cycle</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c_wash_desorbed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">bt_first_load_out</span><span class="p">,</span> <span class="n">bt_first_wash_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_recycle_propagation</span><span class="p">(</span>
                <span class="n">f_first_load</span><span class="p">[:</span><span class="n">i_t_first_cycle</span><span class="p">],</span> <span class="n">bt_first_load</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_t_first_cycle</span><span class="p">],</span> <span class="n">c_wash_desorbed</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_estimate_with_iterative_solver</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Estimating cycle duration: Assuming sharp breakthrough profile&quot;</span><span class="p">)</span>
                <span class="n">i_load_recycle_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">m_load_recycle</span> <span class="o">=</span> \
                    <span class="n">bt_first_load_out</span><span class="p">[:,</span> <span class="n">i_load_recycle_start</span><span class="p">:</span><span class="n">i_t_first_cycle</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
                <span class="n">_t_diff</span> <span class="o">=</span> <span class="n">m_load_recycle</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">/</span> <span class="n">load_c_ss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">t_cycle</span> <span class="o">-=</span> <span class="n">_t_diff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_recycle_m_ss</span> <span class="o">=</span> <span class="n">m_load_recycle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;m_load_recycle_ss&#39;</span><span class="p">,</span> <span class="n">m_load_recycle</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;shorten_cycle_t_due_to_bt_recycle&#39;</span><span class="p">,</span> <span class="n">_t_diff</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_estimate_with_iterative_solver</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Estimating cycle duration: Assuming sharp breakthrough profile&quot;</span><span class="p">)</span>
                <span class="n">m_wash_recycle</span> <span class="o">=</span> <span class="n">bt_first_wash_out</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
                <span class="n">_t_diff</span> <span class="o">=</span> <span class="n">m_wash_recycle</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">/</span> <span class="n">load_c_ss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">t_cycle</span> <span class="o">-=</span> <span class="n">_t_diff</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_m_ss</span> <span class="o">=</span> <span class="n">m_wash_recycle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;m_wash_recycle_ss&#39;</span><span class="p">,</span> <span class="n">m_wash_recycle</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;shorten_cycle_t_due_to_wash_recycle&#39;</span><span class="p">,</span> <span class="n">_t_diff</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_estimate_with_iterative_solver</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span><span class="p">):</span>
                <span class="n">c_load_fist_cycle</span> <span class="o">=</span> <span class="n">load_c_ss</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">binding_species</span><span class="p">),</span> <span class="n">i_t_first_cycle</span> <span class="o">*</span> <span class="mi">2</span><span class="p">])</span>

                <span class="k">def</span> <span class="nf">sim_cycle</span><span class="p">(</span><span class="n">f_load</span><span class="p">,</span> <span class="n">c_load</span><span class="p">,</span> <span class="n">i_prev_cycle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="c1"># load</span>
                    <span class="n">bt_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">c_load</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span><span class="o">.</span><span class="n">calc_c_bound</span><span class="p">(</span><span class="n">f_load</span><span class="p">,</span> <span class="n">c_load</span><span class="p">)</span>
                    <span class="c1"># propagate breakthrough</span>
                    <span class="n">bt_load_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_recycle_propagation</span><span class="p">(</span><span class="n">f_load</span><span class="p">,</span> <span class="n">bt_load</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># &#39;stop&#39; load at specified breakthrough criteria</span>
                    <span class="c1"># noinspection PyTypeChecker</span>
                    <span class="n">i_cycle_duration</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start</span><span class="p">(</span><span class="n">bt_load_out</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">load_c_end_ss</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="c1"># cut load at specified time</span>
                    <span class="n">bt_load</span> <span class="o">=</span> <span class="n">bt_load</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_cycle_duration</span><span class="p">]</span>

                    <span class="c1"># wash desorption</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
                        <span class="n">c_first_wash_desorbed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_wash_desorption</span><span class="p">(</span>
                            <span class="n">f_load</span><span class="p">[:</span><span class="n">i_cycle_duration</span><span class="p">],</span>
                            <span class="n">c_load</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_cycle_duration</span><span class="p">]</span> <span class="o">-</span> <span class="n">bt_load</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_cycle_duration</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">c_first_wash_desorbed</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># propagate load and wash leftovers</span>
                    <span class="n">bt_load_out</span><span class="p">,</span> <span class="n">bt_wash_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_recycle_propagation</span><span class="p">(</span>
                        <span class="n">f_load</span><span class="p">[:</span><span class="n">i_cycle_duration</span><span class="p">],</span> <span class="n">bt_load</span><span class="p">,</span> <span class="n">c_first_wash_desorbed</span>
                    <span class="p">)</span>

                    <span class="c1"># construct load for next cycle</span>
                    <span class="c1"># recycle load</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span><span class="p">:</span>
                        <span class="n">rec_load</span> <span class="o">=</span> <span class="n">bt_load_out</span><span class="p">[:,</span> <span class="n">i_prev_cycle</span><span class="p">:</span><span class="n">i_cycle_duration</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rec_load</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bt_load_out</span><span class="p">[:,</span> <span class="n">i_prev_cycle</span><span class="p">:</span><span class="n">i_cycle_duration</span><span class="p">])</span>
                    <span class="c1"># next load profiles</span>
                    <span class="n">c_next_load</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rec_load</span><span class="p">,</span> <span class="n">c_load_fist_cycle</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">f_next_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">c_next_load</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">wash_recycle_i_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">m_load_recycle_ss</span> <span class="o">=</span> \
                        <span class="n">bt_first_load_out</span><span class="p">[:,</span> <span class="n">wash_recycle_i_duration</span><span class="p">:</span><span class="n">i_t_first_cycle</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_recycle_m_ss</span> <span class="o">=</span> <span class="n">m_load_recycle_ss</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;m_load_recycle_ss&#39;</span><span class="p">,</span> <span class="n">m_load_recycle_ss</span><span class="p">)</span>
                    <span class="c1"># recycle wash</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
                        <span class="n">c_next_load</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt_wash_out</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span><span class="p">]</span>
                        <span class="n">f_next_load</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span>
                        <span class="n">m_wash_recycle_ss</span> <span class="o">=</span> \
                            <span class="n">bt_wash_out</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_m_ss</span> <span class="o">=</span> <span class="n">m_wash_recycle_ss</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;m_wash_recycle_ss&#39;</span><span class="p">,</span> <span class="n">m_wash_recycle_ss</span><span class="p">)</span>

                    <span class="c1"># return next load and cycle duration</span>
                    <span class="k">return</span> <span class="n">f_next_load</span><span class="p">,</span> <span class="n">c_next_load</span><span class="p">,</span> <span class="n">i_cycle_duration</span> <span class="o">-</span> <span class="n">i_prev_cycle</span>

                <span class="n">f_load_cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">c_load_fist_cycle</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">c_load_cycle</span> <span class="o">=</span> <span class="n">c_load_fist_cycle</span>
                <span class="n">i_t_cycle_prev</span> <span class="o">=</span> <span class="n">i_t_first_cycle</span>
                <span class="n">i_t_cycle_estimate</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># loop until cycle duration converges</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_estimate_with_iterative_solver_max_iter</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i_t_cycle_prev</span> <span class="o">-</span> <span class="n">i_t_cycle_estimate</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;t_cycle_optimization_loop_iter&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">i_t_cycle_prev</span> <span class="o">=</span> <span class="n">i_t_cycle_estimate</span>
                    <span class="n">f_load_cycle</span><span class="p">,</span> <span class="n">c_load_cycle</span><span class="p">,</span> <span class="n">i_t_cycle_estimate</span> <span class="o">=</span> \
                        <span class="n">sim_cycle</span><span class="p">(</span><span class="n">f_load_cycle</span><span class="p">,</span> <span class="n">c_load_cycle</span><span class="p">,</span> <span class="n">i_t_cycle_prev</span><span class="p">)</span>
                    <span class="c1"># print([i, i_t_cycle_prev, i_t_cycle_estimate])</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i_t_cycle_prev</span> <span class="o">-</span> <span class="n">i_t_cycle_estimate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Cycle duration estimator did not converge&quot;</span><span class="p">)</span>

                <span class="n">t_cycle</span> <span class="o">=</span> <span class="n">i_t_cycle_estimate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_c_end_estimate_with_iterative_solver</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;No need to use iterative solver in case of no recycling of load and/or wash&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_t</span> <span class="o">=</span> <span class="n">t_cycle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s1">&#39;cycle_t&#39;</span><span class="p">,</span> <span class="n">t_cycle</span><span class="p">)</span>

    <span class="c1"># noinspection DuplicatedCode</span>
    <span class="k">def</span> <span class="nf">_calc_first_cycle_extension_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Estimation of first cycle extension requested on a process without load recycle&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Estimation of first cycle extension requested on a process without extended first cycle&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle_t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle_t</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle_cv</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;CV should be defined by now&quot;</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Load flow rate should be defined by now&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle_cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Estimation of first cycle extension is only supported if the cycle length &quot;</span>
                <span class="s2">&quot;is defined by breakthrough cutoff criteria. This is due to the fact that if all the &quot;</span>
                <span class="s2">&quot;breakthrough material gets recycles, there is no single steady-state.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binding_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">]</span>
            <span class="n">load_c_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_steady_state_mean_c</span><span class="p">(</span><span class="n">binding_species</span><span class="p">)</span>

            <span class="c1">#  simulate first cycle at constant load concentration</span>
            <span class="n">f_first_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">c_first_load</span> <span class="o">=</span> <span class="n">load_c_ss</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">binding_species</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
            <span class="n">bt_first_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">load_c_ss</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span><span class="o">.</span><span class="n">calc_c_bound</span><span class="p">(</span><span class="n">f_first_load</span><span class="p">,</span> <span class="n">c_first_load</span><span class="p">)</span>

            <span class="c1"># propagate breakthrough</span>
            <span class="n">bt_first_load_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_recycle_propagation</span><span class="p">(</span><span class="n">f_first_load</span><span class="p">,</span> <span class="n">bt_first_load</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">load_c_end_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_load_bt_cycle_switch_limit</span><span class="p">(</span><span class="n">load_c_ss</span><span class="p">)</span>

            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="n">i_t_first_cycle</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start</span><span class="p">(</span><span class="n">bt_first_load_out</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">load_c_end_ss</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_load_recycle_m_ss&quot;</span><span class="p">),</span> <span class="s2">&quot;Function `_calc_cycle_t()` should already be called.&quot;</span>
                <span class="n">dm</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_recycle_m_ss</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_wash_recycle_m_ss&quot;</span><span class="p">),</span> <span class="s2">&quot;Function `_calc_cycle_t()` should already be called.&quot;</span>
                <span class="n">dm</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_m_ss</span>

            <span class="n">di</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">dm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">m_ext_bt</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">bt_first_load_out</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="n">i_t_first_cycle</span><span class="p">:])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
                <span class="n">di</span> <span class="o">+=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start</span><span class="p">(</span><span class="n">m_ext_bt</span> <span class="o">&gt;=</span> <span class="n">dm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span> <span class="o">=</span> <span class="n">di</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>

    <span class="k">def</span> <span class="nf">_calc_cycle_start_i_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Cycle length must have been determined (by `_calc_cycle_t`) by now&quot;</span>
        <span class="n">flow_i_start</span><span class="p">,</span> <span class="n">flow_i_end</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start_and_end</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> \
                <span class="s2">&quot;Prolong of first load cycle is set to True, but the length is undefined&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;Prolong of first load cycle is set to True, but the length of the extension is 0&quot;</span><span class="p">)</span>
            <span class="n">load_extend_first_cycle_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_cycle_extension_t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;load_extend_first_cycle_t&quot;</span><span class="p">,</span> <span class="n">load_extend_first_cycle_t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load_extend_first_cycle_t</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">cycle_start_t_list</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">flow_i_start</span><span class="p">]</span> <span class="o">+</span> <span class="n">load_extend_first_cycle_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">flow_i_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_t</span>
        <span class="p">)</span>

        <span class="n">cycle_start_t_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[</span><span class="n">flow_i_start</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">cycle_start_t_list</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;cycle_start_t_list&quot;</span><span class="p">,</span> <span class="n">cycle_start_t_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare everything before simulation loop over cycles&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_non_binding_species</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_load_f</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_cv</span><span class="p">()</span>  <span class="c1"># might depend on load_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_report_column_dimensions</span><span class="p">()</span>  <span class="c1"># optional</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_equilibration_t</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_wash_t_and_f</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_elution_t_and_f</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_elution_peak_t</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_elution_peak_pdf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_elution_peak_cut_i_start_and_i_end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_elution_peak_mask</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_regeneration_t</span><span class="p">()</span>

        <span class="c1"># prepare for estimation of cycle length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_load_btc</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_load_recycle_pdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_load_recycle_wash_i</span><span class="p">()</span>
        <span class="c1"># calc cycle time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_cycle_t</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_extend_first_cycle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_first_cycle_extension_t</span><span class="p">()</span>
        <span class="c1"># calc cycle start positions -&gt; column switch time points (at load)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_cycle_start_i_list</span><span class="p">()</span>

        <span class="c1"># make sure cycle duration is long enough</span>
        <span class="n">_t_cycle_except_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equilibration_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regeneration_t</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_t</span> <span class="o">&lt;</span> <span class="n">_t_cycle_except_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">e</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load step (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_t</span><span class="si">}</span><span class="s2">) should not be shorter&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot; than eq_t + wash_t + elution_t + regeneration_t&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">_t_cycle_except_load</span><span class="si">:</span><span class="s2"> .6</span><span class="si">}</span><span class="s2">)!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sim_c_load_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">c_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates load against breakthrough profile to determine what part of load binds.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">f_load</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">c_load</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
            <span class="s2">&quot;f_load and c_load must have the same length&quot;</span>
        <span class="k">assert</span> <span class="n">c_load</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">),</span> \
            <span class="s2">&quot;c_load must contain all binding species&quot;</span>

        <span class="n">c_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span><span class="o">.</span><span class="n">calc_c_bound</span><span class="p">(</span><span class="n">f_load</span><span class="p">,</span> <span class="n">c_load</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c_bound</span><span class="p">,</span> <span class="n">c_load</span> <span class="o">-</span> <span class="n">c_bound</span>  <span class="c1"># returns bound and unbound parts</span>

    <span class="k">def</span> <span class="nf">_sim_c_wash_desorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">c_bound</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns concentration profile of desorbed material during wash step.&quot;&quot;&quot;</span>

        <span class="c1"># Not implemented in core this class, as there is no consensus on typical dynamics or way to describe it.</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Function not implemented in this class&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sim_c_recycle_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">f_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">c_load_unbound</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">c_wash_desorbed</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate the unbound (breakthrough during load) and desorbed (during wash) material through the column</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f_load</span>
<span class="sd">            Flow rate profile of load step (which includes load step + possible wash and load recycle).</span>
<span class="sd">        c_load_unbound</span>
<span class="sd">            Concentration profile of overloaded material during load step (+ previous wash and load recycle).</span>
<span class="sd">        c_wash_desorbed</span>
<span class="sd">            Concentration profile of desorbed material during wash step.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (_np.ndarray, _np.ndarray)</span>
<span class="sd">            c_unbound_propagated</span>
<span class="sd">                Propagated (through the column) concentration profile of overloaded material during load step.</span>
<span class="sd">            c_wash_desorbed_propagated</span>
<span class="sd">                Propagated (through the column) concentration profile of desorbed material during wash step.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_wash_f&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_wash_t&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">c_load_unbound</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">c_load_unbound</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">f_load</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">c_wash_desorbed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">c_wash_desorbed</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c_wash_desorbed</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">c_wash_desorbed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">c_wash_desorbed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> \
                <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))</span>

        <span class="c1"># combine on volumetric scale</span>
        <span class="n">v_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">*</span> <span class="n">f_load</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">v_wash</span> <span class="o">=</span> <span class="n">v_load</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">c_wash_desorbed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span>
        <span class="n">min_flow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">f_load</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span><span class="p">)</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">min_flow</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="p">(</span><span class="n">v_wash</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">v_wash</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">v_load</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dv</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
        <span class="n">c_v_combined</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
            <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">v_load</span><span class="p">,</span> <span class="n">v_wash</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">c_load_unbound</span><span class="p">,</span> <span class="n">c_wash_desorbed</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span>
        <span class="p">)(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">c_v_combined</span><span class="p">[</span><span class="n">c_v_combined</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># simulate traveling of leftover material through the column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_load_recycle_pdf</span><span class="p">(</span><span class="n">min_flow</span><span class="p">)</span>
        <span class="n">c_v_combined_propagated</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">convolution</span><span class="o">.</span><span class="n">time_conv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">,</span> <span class="n">c_v_combined</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_load_recycle_pdf</span><span class="p">)</span>

        <span class="c1"># split back on time scale</span>
        <span class="n">c_combined_propagated</span> <span class="o">=</span> <span class="n">_interp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
            <span class="n">v</span><span class="p">,</span>
            <span class="n">c_v_combined_propagated</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span>
        <span class="p">)(</span><span class="n">_np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">v_load</span><span class="p">,</span> <span class="n">v_wash</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">c_combined_propagated</span><span class="p">[</span><span class="n">c_combined_propagated</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">c_unbound_propagated</span> <span class="o">=</span> <span class="n">c_combined_propagated</span><span class="p">[:,</span> <span class="p">:</span><span class="n">v_load</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
        <span class="n">c_wash_desorbed_propagated</span> <span class="o">=</span> <span class="n">c_combined_propagated</span><span class="p">[:,</span> <span class="n">v_load</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">c_unbound_propagated</span><span class="p">,</span> <span class="n">c_wash_desorbed_propagated</span>

    <span class="k">def</span> <span class="nf">_sim_c_elution_desorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_bound</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate elution step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m_bound</span>
<span class="sd">            Vector with amount of product being bound to the column. `m_bound.size == n_species`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (_np.ndarray, _np.ndarray)</span>
<span class="sd">            c_elution</span>
<span class="sd">                Outlet concentration profile during the elution.</span>
<span class="sd">            mask_elution_peak</span>
<span class="sd">                Boolean vector. The peak is collected where the value is `True`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_t</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">i_elution_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elution_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))</span>

        <span class="n">c_elution</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_p_elution_peak</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:</span><span class="n">i_elution_duration</span><span class="p">]</span> <span class="o">*</span> \
            <span class="n">m_bound</span><span class="p">[:,</span> <span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span>

        <span class="k">if</span> <span class="n">c_elution</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i_elution_duration</span><span class="p">:</span>
            <span class="n">c_elution</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">c_elution</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_elution_duration</span> <span class="o">-</span> <span class="n">c_elution</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>

        <span class="n">mask_elution_peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_peak_mask</span>

        <span class="k">return</span> <span class="n">c_elution</span><span class="p">,</span> <span class="n">mask_elution_peak</span>

    <span class="k">def</span> <span class="nf">_sim_c_elution_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_time_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Feel free to override this function if you want to simulate linear gradient&quot;&quot;&quot;</span>

        <span class="c1"># elution buffer composition</span>
        <span class="n">elution_buffer_composition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elution_buffer_c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elution_buffer_c</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">elution_buffer_composition</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">elution_buffer_composition</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span><span class="p">,</span> \
            <span class="s2">&quot;Elution buffer composition must be either empty or have a concentration value for each specie&quot;</span>

        <span class="k">assert</span> <span class="n">_np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">elution_buffer_composition</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Concentration values in elution buffer must be &gt;= 0&quot;</span>

        <span class="k">if</span> <span class="n">elution_buffer_composition</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elution_buffer_composition</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;elution_buffer_composition&quot;</span><span class="p">,</span> <span class="n">elution_buffer_composition</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">elution_buffer_composition</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[:</span><span class="n">n_time_steps</span><span class="p">])</span>

    <span class="c1"># noinspection PyMethodMayBeStatic,PyUnusedLocal</span>
    <span class="k">def</span> <span class="nf">_sim_c_regeneration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_bound</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate regeneration step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        m_bound</span>
<span class="sd">            Vector with amount of product being bound to the column. `m_bound.size == n_species`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _typing.Optional[_np.ndarray]</span>
<span class="sd">            Outlet concentration profile during regeneration step.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c_regeneration</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">c_regeneration</span>

    <span class="k">def</span> <span class="nf">_sim_c_out_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">c_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                                                                             <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                                                                             <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                                             <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                                             <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates load-wash-elution-regeneration steps. Regeneration is optional.</span>

<span class="sd">        This function can be replaced in case user wants to use some other evaluation of bind-elution dynamics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f_load: _np.ndarray</span>
<span class="sd">            Inlet load flow rate profile. It might be changing due to wash recycle.</span>
<span class="sd">        c_load: _np.ndarray</span>
<span class="sd">            Inlet load concentration profile.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (_typing.Optional[_np.ndarray], _typing.Optional[_np.ndarray],</span>
<span class="sd">         _np.ndarray, _np.ndarray,</span>
<span class="sd">         _typing.Optional[_np.ndarray])</span>
<span class="sd">            Concentration profiles at the outlet of the column for load, wash, elution and regeneration steps.</span>
<span class="sd">            Elution peak cut is applied in this function. Elution peak must be defined.</span>
<span class="sd">            Profiles that are `None` are considered being zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_t</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># evaluate binding</span>
        <span class="n">c_bound</span><span class="p">,</span> <span class="n">c_unbound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_load_binding</span><span class="p">(</span><span class="n">f_load</span><span class="p">,</span> <span class="n">c_load</span><span class="p">)</span>
        <span class="c1"># log</span>
        <span class="n">m_load</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_load</span> <span class="o">*</span> <span class="n">f_load</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
        <span class="n">m_bound</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_bound</span> <span class="o">*</span> <span class="n">f_load</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;column_utilization&quot;</span><span class="p">,</span> <span class="n">m_bound</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_bt</span><span class="o">.</span><span class="n">get_total_bc</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_load&quot;</span><span class="p">,</span> <span class="n">m_load</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_bound&quot;</span><span class="p">,</span> <span class="n">m_bound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_unbound&quot;</span><span class="p">,</span> <span class="n">m_load</span> <span class="o">-</span> <span class="n">m_bound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;f_load&quot;</span><span class="p">,</span> <span class="n">f_load</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_load&quot;</span><span class="p">,</span> <span class="n">c_load</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_bound&quot;</span><span class="p">,</span> <span class="n">c_bound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_unbound&quot;</span><span class="p">,</span> <span class="n">c_unbound</span><span class="p">)</span>

        <span class="c1"># evaluate desorption during wash</span>
        <span class="n">c_wash_desorbed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption</span><span class="p">:</span>
            <span class="n">c_wash_desorbed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_wash_desorption</span><span class="p">(</span><span class="n">f_load</span><span class="p">,</span> <span class="n">c_bound</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c_wash_desorbed</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">m_bound</span> <span class="o">-=</span> <span class="n">c_wash_desorbed</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># subtract desorbed material from bound material</span>
            <span class="c1"># log</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_wash_desorbed&quot;</span><span class="p">,</span> <span class="n">c_wash_desorbed</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_wash_desorbed&quot;</span><span class="p">,</span> <span class="n">c_wash_desorbed</span><span class="p">)</span>

        <span class="c1"># propagate unbound and desorbed material throughout the column</span>
        <span class="n">c_out_load</span> <span class="o">=</span> <span class="n">c_unbound</span>
        <span class="n">c_out_wash</span> <span class="o">=</span> <span class="n">c_wash_desorbed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
            <span class="n">c_out_load</span><span class="p">,</span> <span class="n">c_out_wash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_recycle_propagation</span><span class="p">(</span><span class="n">f_load</span><span class="p">,</span> <span class="n">c_unbound</span><span class="p">,</span> <span class="n">c_wash_desorbed</span><span class="p">)</span>

        <span class="c1"># get elution peak</span>
        <span class="n">c_out_elution</span><span class="p">,</span> <span class="n">elution_peak_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_elution_desorption</span><span class="p">(</span><span class="n">m_bound</span><span class="p">)</span>
        <span class="c1"># log</span>
        <span class="n">m_elution_peak</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_out_elution</span> <span class="o">*</span> <span class="n">elution_peak_mask</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
        <span class="n">m_elution</span> <span class="o">=</span> <span class="n">c_out_elution</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_elution_peak&quot;</span><span class="p">,</span> <span class="n">m_elution_peak</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_elution&quot;</span><span class="p">,</span> <span class="n">m_elution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_elution_peak_cut_loss&quot;</span><span class="p">,</span> <span class="n">m_elution</span> <span class="o">-</span> <span class="n">m_elution_peak</span><span class="p">)</span>

        <span class="c1"># get regeneration peak</span>
        <span class="n">c_out_regeneration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_regeneration</span><span class="p">(</span><span class="n">m_bound</span> <span class="o">-</span> <span class="n">c_out_elution</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c_out_load</span><span class="p">,</span> <span class="n">c_out_wash</span><span class="p">,</span> <span class="n">c_out_elution</span><span class="p">,</span> <span class="n">elution_peak_mask</span><span class="p">,</span> <span class="n">c_out_regeneration</span>

    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># pre calculate parameters and repetitive profiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_simulation</span><span class="p">()</span>

        <span class="n">binding_species</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span><span class="p">)</span>
                           <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">binding_species</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># copy inlet vectors</span>
        <span class="n">c_in_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">[</span><span class="n">binding_species</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">f_in_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">f_in_i_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_end</span><span class="p">(</span><span class="n">f_in_load</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">c_in_load</span><span class="p">[:,</span> <span class="n">f_in_i_end</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># clear for results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># prepare logger</span>
        <span class="n">log_data_cycles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">set_branch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_tree</span><span class="p">,</span> <span class="s2">&quot;cycles&quot;</span><span class="p">,</span> <span class="n">log_data_cycles</span><span class="p">)</span>

        <span class="c1"># util variable</span>
        <span class="n">previous_c_bt_wash</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            In one cycle we focus on load-wash-elution-regeneration-equilibration on the column.</span>
<span class="sd">            </span>
<span class="sd">            The loading step starts at `self._cycle_start_i_list[i]`.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># prepare logger for this cycle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">log_data_cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">)</span>

            <span class="c1"># Load start and end time as the column sees it</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span><span class="p">:</span>
                <span class="c1"># column sees leftovers from previous load during recycling</span>
                <span class="n">cycle_load_i_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cycle_load_i_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Calc cycle end (either next cycle or end or simulation time)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">cycle_load_i_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cycle_load_i_end</span> <span class="o">=</span> <span class="n">f_in_i_end</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1"># log results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;i_cycle_load_start&quot;</span><span class="p">,</span> <span class="n">cycle_load_i_start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;i_cycle_load_step_start&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;i_cycle_load_end&quot;</span><span class="p">,</span> <span class="n">cycle_load_i_end</span><span class="p">)</span>

            <span class="c1"># calc profiles at column outlet</span>
            <span class="n">c_out_load</span><span class="p">,</span> <span class="n">c_out_wash</span><span class="p">,</span> <span class="n">c_out_elution</span><span class="p">,</span> <span class="n">b_out_elution</span><span class="p">,</span> <span class="n">c_out_regeneration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim_c_out_cycle</span><span class="p">(</span>
                <span class="n">f_in_load</span><span class="p">[</span><span class="n">cycle_load_i_start</span><span class="p">:</span><span class="n">cycle_load_i_end</span><span class="p">],</span>
                <span class="n">c_in_load</span><span class="p">[:,</span> <span class="n">cycle_load_i_start</span><span class="p">:</span><span class="n">cycle_load_i_end</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_out_load&quot;</span><span class="p">,</span> <span class="n">c_out_load</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_out_wash&quot;</span><span class="p">,</span> <span class="n">c_out_wash</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_out_elution&quot;</span><span class="p">,</span> <span class="n">c_out_elution</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;b_out_elution&quot;</span><span class="p">,</span> <span class="n">b_out_elution</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_out_regeneration&quot;</span><span class="p">,</span> <span class="n">c_out_regeneration</span><span class="p">)</span>

            <span class="c1"># load recycle</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span><span class="p">:</span>
                <span class="c1"># recycle load during the load step</span>
                <span class="n">i_load_start_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cycle_load_i_start</span>
                <span class="n">c_load_recycle</span> <span class="o">=</span> <span class="n">c_out_load</span><span class="p">[:,</span> <span class="n">i_load_start_rel</span><span class="p">:]</span>
                <span class="n">c_in_load</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">cycle_load_i_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_load_recycle</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_load_recycle&quot;</span><span class="p">,</span> <span class="n">c_load_recycle</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_load_recycle&quot;</span><span class="p">,</span> <span class="n">c_load_recycle</span><span class="p">)</span>
                <span class="c1"># losses during load == bt through 2nd column == bt before start of load step</span>
                <span class="n">c_loss_bt_2nd_column</span> <span class="o">=</span> <span class="n">c_out_load</span><span class="p">[:,</span> <span class="n">i_load_start_rel</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_loss_bt_2nd_column&quot;</span><span class="p">,</span>
                                <span class="n">c_loss_bt_2nd_column</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_loss_bt_2nd_column&quot;</span><span class="p">,</span> <span class="n">c_loss_bt_2nd_column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># report losses during load</span>
                <span class="n">m_loss_load</span> <span class="o">=</span> <span class="n">c_out_load</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_loss_load&quot;</span><span class="p">,</span> <span class="n">m_loss_load</span><span class="p">)</span>

            <span class="c1"># wash recycle</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">previous_c_bt_wash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">previous_c_bt_wash</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># clip wash recycle duration if needed</span>
                    <span class="n">i_wash_duration</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_recycle_i_duration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="c1"># report losses due to discarding load bt while recycling wash</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">c_in_load</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">i_wash_duration</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span>
                                    <span class="s2">&quot;m_loss_load_bt_during_wash_recycle&quot;</span><span class="p">,</span>
                                    <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_lost_load_during_wash_recycle&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">d_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;c_wash_recycle&quot;</span><span class="p">,</span> <span class="n">previous_c_bt_wash</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_wash_duration</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_wash_recycle&quot;</span><span class="p">,</span>
                                    <span class="n">previous_c_bt_wash</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_wash_duration</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span><span class="p">)</span>

                    <span class="c1"># apply previous wash recycle onto the inlet profile</span>
                    <span class="n">s</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">previous_c_bt_wash</span><span class="p">[:,</span> <span class="p">:</span><span class="n">i_wash_duration</span><span class="p">]</span>
                    <span class="n">f_in_load</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_start_i_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">i_wash_duration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span>
                <span class="c1"># save wash from this cycle to be applied during the next cycle</span>
                <span class="n">previous_c_bt_wash</span> <span class="o">=</span> <span class="n">c_out_wash</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># report losses during wash</span>
                <span class="k">if</span> <span class="n">c_out_wash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">c_out_wash</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">binding_species</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))])</span>
                <span class="n">m_loss_wash</span> <span class="o">=</span> <span class="n">c_out_wash</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;m_loss_wash&quot;</span><span class="p">,</span> <span class="n">m_loss_wash</span><span class="p">)</span>

            <span class="c1"># elution</span>
            <span class="p">[</span><span class="n">i_el_rel_start</span><span class="p">,</span> <span class="n">i_el_rel_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">true_start_and_end</span><span class="p">(</span><span class="n">b_out_elution</span><span class="p">)</span>
            <span class="n">i_el_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">cycle_load_i_end</span> <span class="o">+</span> <span class="n">c_out_wash</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i_el_rel_start</span><span class="p">)</span>
            <span class="n">i_el_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">cycle_load_i_end</span> <span class="o">+</span> <span class="n">c_out_wash</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i_el_rel_end</span><span class="p">)</span>
            <span class="n">i_el_rel_end</span> <span class="o">=</span> <span class="n">i_el_rel_start</span> <span class="o">+</span> <span class="n">i_el_end</span> <span class="o">-</span> <span class="n">i_el_start</span>
            <span class="c1"># log</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;i_elution_start&quot;</span><span class="p">,</span> <span class="n">i_el_start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">i_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cycle_tree</span><span class="p">,</span> <span class="s2">&quot;i_elution_end&quot;</span><span class="p">,</span> <span class="n">i_el_end</span><span class="p">)</span>

            <span class="c1"># write to global outlet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_f</span><span class="p">[</span><span class="n">i_el_start</span><span class="p">:</span><span class="n">i_el_end</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elution_f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="p">[</span><span class="n">binding_species</span><span class="p">,</span> <span class="n">i_el_start</span><span class="p">:</span><span class="n">i_el_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_out_elution</span><span class="p">[:,</span> <span class="n">i_el_rel_start</span><span class="p">:</span><span class="n">i_el_rel_end</span><span class="p">]</span></div>


<div class="viewcode-block" id="ACC"><a class="viewcode-back" href="../../../bio_rtd/uo.sc_uo.html#bio_rtd.uo.sc_uo.ACC">[docs]</a><span class="k">class</span> <span class="nc">ACC</span><span class="p">(</span><span class="n">AlternatingChromatography</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_sim_c_wash_desorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">c_bound</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Function not implemented in this class&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PCC"><a class="viewcode-back" href="../../../bio_rtd/uo.sc_uo.html#bio_rtd.uo.sc_uo.PCC">[docs]</a><span class="k">class</span> <span class="nc">PCC</span><span class="p">(</span><span class="n">AlternatingChromatography</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">t</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">uo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">load_bt</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">ChromatographyLoadBreakthrough</span><span class="p">,</span>
                 <span class="n">load_recycle_pdf</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span>
                 <span class="n">column_porosity_retentate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">peak_shape_pdf</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span>
                 <span class="n">gui_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PCC&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">uo_id</span><span class="p">,</span> <span class="n">load_bt</span><span class="p">,</span> <span class="n">peak_shape_pdf</span><span class="p">,</span> <span class="n">gui_title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># how fast is the protein traveling through the column during overloaded conditions (in CVs)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_porosity_retentate</span> <span class="o">=</span> <span class="n">column_porosity_retentate</span>
        <span class="c1"># corresponding peak shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle_pdf</span> <span class="o">=</span> <span class="n">load_recycle_pdf</span>

    <span class="k">def</span> <span class="nf">_sim_c_wash_desorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">c_bound</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Function not implemented in this class&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PCCWithWashDesorption"><a class="viewcode-back" href="../../../bio_rtd/uo.sc_uo.html#bio_rtd.uo.sc_uo.PCCWithWashDesorption">[docs]</a><span class="k">class</span> <span class="nc">PCCWithWashDesorption</span><span class="p">(</span><span class="n">PCC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">t</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">uo_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">load_bt</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">ChromatographyLoadBreakthrough</span><span class="p">,</span>
                 <span class="n">load_recycle_pdf</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span>
                 <span class="n">column_porosity_retentate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">peak_shape_pdf</span><span class="p">:</span> <span class="n">_core</span><span class="o">.</span><span class="n">PDF</span><span class="p">,</span>
                 <span class="n">gui_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PCCWithWashDesorption&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">uo_id</span><span class="p">,</span> <span class="n">load_bt</span><span class="p">,</span> <span class="n">load_recycle_pdf</span><span class="p">,</span>
                         <span class="n">column_porosity_retentate</span><span class="p">,</span> <span class="n">peak_shape_pdf</span><span class="p">,</span> <span class="n">gui_title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_recycle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_recycle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># one of those must be defined</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_material_share</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_above_dbc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># this one must be defined</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_tail_half_time_cv</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_sim_c_wash_desorption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_load</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">c_bound</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_tail_half_time_cv</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_material_share</span> <span class="o">&gt;</span> <span class="mi">0</span> \
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_above_dbc</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">f_load</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">c_bound</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">c_bound</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
            <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_species</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_binding_species</span><span class="p">)</span>

        <span class="n">m_bound</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_bound</span> <span class="o">*</span> <span class="n">f_load</span><span class="p">[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span>

        <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_material_share</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_material_share</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_above_dbc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s2">&quot;share of desorbable material defined twice!! &quot;</span>
                           <span class="s2">&quot;Using load_recycle_wash_desorbable_material_share&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_desorbable_above_dbc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="n">m_bound</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="k">assert</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="n">i_wash_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wash_t</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dt</span><span class="p">))</span>

        <span class="c1"># generate exponential tail</span>
        <span class="n">exp_pdf</span> <span class="o">=</span> <span class="n">_pdf</span><span class="o">.</span><span class="n">TanksInSeries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">[:</span><span class="n">i_wash_duration</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wash_desorption_tail_half_time_cv</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">exp_pdf</span><span class="o">.</span><span class="n">update_pdf</span><span class="p">(</span><span class="n">rt_mean</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
        <span class="c1"># scale desorbed material concentration due to differences in flow rate (ensure mass balance)</span>
        <span class="n">c_desorbed</span> <span class="o">=</span> <span class="n">m_bound</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">exp_pdf</span><span class="o">.</span><span class="n">get_p</span><span class="p">()[</span><span class="n">_np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:</span><span class="n">i_wash_duration</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wash_f</span>
        <span class="n">c_desorbed</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">c_desorbed</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_wash_duration</span> <span class="o">-</span> <span class="n">c_desorbed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>

        <span class="c1"># cut</span>
        <span class="k">return</span> <span class="n">c_desorbed</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, University of Natural Resources and Life Sciences (BOKU), Vienna

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>